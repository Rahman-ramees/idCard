<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Agency - Start Bootstrap Theme</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
        <style>
            .photo-option {
                margin-top: 15px;
            }
            .photo-option-content {
                display: none;
                margin-top: 10px;
            }
            .photo-option.active .photo-option-content {
                display: block;
            }
            #imagePreview, #capturedPhoto {
                max-width: 100%;
                margin-top: 10px;
                display: none;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 5px;
                background-color: #f8f9fa;
            }
            .error-message {
                color: red;
                font-size: 0.875em;
                margin-top: 5px;
                display: none;
            }
            .loader {
                border: 4px solid #f3f3f3;
                border-top: 4px solid #3498db;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                animation: spin 1s linear infinite;
                margin: 10px auto;
                display: none;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            #video {
                background-color: #f8f9fa;
                width: 100%;
                max-height: 300px;
                border: 1px solid #ddd;
                border-radius: 4px;
            }
            #canvas {
                display: none;
            }
            .photo-preview-container {
                margin-top: 10px;
                text-align: center;
            }
            .form-group select {
                appearance: none;
                -webkit-appearance: none;
                -moz-appearance: none;
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right 0.75rem center;
                background-size: 1em;
            }
            #submitSuccessMessage {
                display: block;
            }
            #submitButton {
                display: none;
            }
            label{
                color: white;
            }
        </style>
    </head>
    <body id="page-top">
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-dark fixed-top" id="mainNav">
            <div class="container">
                <a class="navbar-brand" href="#page-top">
                    <img src="assets/img/idcreatorLogo1.png" alt="..." />
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    Menu
                    <i class="fas fa-bars ms-1"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav text-uppercase ms-auto py-4 py-lg-0">
                        <li class="nav-item"><a class="nav-link" href="#contact">Create Your ID Card</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <!-- Masthead-->
        <header class="masthead">
            <div class="container">
                <div class="masthead-subheading">Your ID Card, Your Way!</div>
                <div class="masthead-heading text-uppercase">We're Excited To Help You Design Your Card.</div>
                <a class="btn btn-primary btn-xl text-uppercase" href="#contact">Create Your ID Card</a>
            </div>
        </header>
        
        <!-- Contact-->
        <!-- Contact-->
<section class="page-section" id="contact">
    <div class="container">
        <div class="text-center">
            <h2 class="section-heading text-uppercase">Student ID Card Details</h2>
            <h3 class="section-subheading text-muted">Please provide accurate information for your ID card.</h3>
        </div>
        <form id="contactForm" onsubmit="return validateForm()">
            <div class="row align-items-stretch mb-5">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="Student name">Student name *</label>
                        <input class="form-control" id="name" type="text" placeholder="Student Name *" required />
                        <div class="error-message" id="nameError">Student name is required.</div>
                    </div>
                    <div class="form-group">
                        <label for="Parent/guardian">Parent/guardian *</label>
                        <input class="form-control" id="parentsName" type="text" placeholder="Parent/Guardian Name *" required />
                        <div class="error-message" id="parentsNameError">Parent/guardian name is required.</div>
                    </div>
                    <div class="form-group">
                        <label for="Address">Address *</label>
                        <textarea class="form-control" id="address" placeholder="Address *" required></textarea>
                        <div class="error-message" id="addressError">Address is required.</div>
                    </div>
                    <div class="form-group">
                        <label for="phone number">Phone number *</label>
                        <input class="form-control" id="phone" type="tel" placeholder="Phone Number *" required />
                        <div class="error-message" id="phoneError">A phone number is required.</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group" style="display: flex;gap: 5px;">
                        <div style="width: 50%;">
                            <label for="standard">Standard/Class *</label>
                            <select id="standard" class="form-control" required>
                                <option value="">-- Select Standard --</option>
                                <option value="LKG">Class LKG</option>
                                <option value="UKG">Class UKG</option>
                                <option value="I">Class I</option>
                                <option value="II">Class II</option>
                                <option value="III">Class III</option>
                                <option value="IV">Class IV</option>
                                <option value="V">Class V</option>
                                <option value="VI">Class VI</option>
                                <option value="VII">Class VII</option>
                                <option value="VIII">Class VIII</option>
                                <option value="IX">Class IX</option>
                                <option value="X">Class X</option>
                                <option value="XI">Class XI</option>
                                <option value="XII">Class XII</option>
                            </select>
                            <div class="error-message" id="standardError">Please select a standard/class.</div>
                        </div>
                        <div style="width: 50%;">
                            <label for="division">Division *</label>
                            <select id="division" class="form-control" required>
                                <option value="">-- Select Division --</option>
                                <option value="a">A</option>
                                <option value="b">B</option>
                                <option value="c">C</option>
                                <option value="d">D</option>
                                <option value="e">E</option>
                                <option value="f">F</option>
                                <option value="g">G</option>
                                <option value="h">H</option>
                            </select>
                            <div class="error-message" id="divisionError">Please select a division.</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bloodGroup">Blood Group *</label>
                        <select id="bloodGroup" class="form-control" required>
                            <option value="">-- Select Blood Group --</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                        <div class="error-message" id="bloodGroupError">Please select a blood group.</div>
                    </div>
                    <div class="form-group">
                        <label for="Admission">Admission *</label>
                        <input class="form-control" id="admissionNo" type="text" placeholder="Admission Number *" required />
                        <div class="error-message" id="admissionNoError">Admission number is required.</div>
                    </div>
                    <div class="form-group">
                        <label for="dob">Date of Birth *</label>
                        <input class="form-control" id="dob" type="date" required />
                        <div class="error-message" id="dobError">Please select date of birth.</div>
                    </div>
                    <div class="form-group">
                        <label for="photoOption">Select Photo Option *</label>
                        <select id="photoOption" class="form-control" onchange="togglePhotoOption()" required>
                            <option value="">-- Select Image option --</option>
                            <option value="camera">Take Live Photo</option>
                            <option value="upload">Upload Photo</option>
                        </select>
                        <div class="error-message" id="photoOptionError">Please select a photo option</div>
                    </div>
                    
                    <!-- Camera Option -->
                    <div id="cameraOption" class="photo-option">
                        <div class="photo-option-content">
                            <video id="video" autoplay></video>
                            <button class="btn btn-primary" type="button" onclick="snap()" style="margin-top: 10px;">Capture Photo</button>
                            <canvas id="canvas"></canvas>
                            <div class="photo-preview-container">
                                <img id="capturedPhoto" alt="Captured Photo Preview" />
                            </div>
                            <div class="error-message" id="cameraError">Please capture a photo first</div>
                        </div>
                    </div>
                    
                    <!-- Upload Option -->
                    <div id="uploadOption" class="photo-option">
                        <div class="photo-option-content">
                            <input class="form-control" id="photoUpload" type="file" accept="image/*" style="margin-top: 10px;" />
                            <div class="photo-preview-container">
                                <img id="imagePreview" alt="Uploaded Photo Preview" />
                            </div>
                            <div class="error-message" id="uploadError">Please upload a photo first</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Submit success message-->
            <div class="d-none" id="submitSuccessMessage">
                <div class="text-center text-white mb-3">
                    <div class="fw-bolder">Form submission successful!</div>
                </div>
            </div>
            
            <!-- Submit error message-->
            <div class="d-none" id="submitErrorMessage"><div class="text-center text-danger mb-3">Error sending message!</div></div>
            
            <!-- Submit Button-->
            <div class="text-center">
                <button class="btn btn-primary btn-x text-uppercase" id="submitButton" type="button" style="padding: 0.5rem 2rem;">Submit</button>
                <div class="loader" id="loader"></div>
            </div>
        </form>
    </div>
</section>
        <!-- Footer-->
        <footer class="footer py-4">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-4 text-lg-start">Copyright &copy; Your Website 2023</div>
                    <div class="col-lg-4 my-3 my-lg-0">
                        <a class="btn btn-dark btn-social mx-2" href="#!" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                        <a class="btn btn-dark btn-social mx-2" href="#!" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a class="btn btn-dark btn-social mx-2" href="#!" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                    <div class="col-lg-4 text-lg-end">
                        <a class="link-dark text-decoration-none me-3" href="#!">Privacy Policy</a>
                        <a class="link-dark text-decoration-none" href="#!">Terms of Use</a>
                    </div>
                </div>
            </div>
        </footer>
        
        <script>
            // Global variables
            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            const uploadInput = document.getElementById("photoUpload");
            const imagePreview = document.getElementById("imagePreview");
            const capturedPhoto = document.getElementById("capturedPhoto");
            const contactForm = document.getElementById("contactForm");
            let photoDataUrl = ''; // Will store the photo data
            let stream = null; // For camera stream
            
            // Initialize camera when camera option is selected
            function initCamera() {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: "user" 
                        } 
                    })
                    .then((cameraStream) => {
                        stream = cameraStream;
                        video.srcObject = stream;
                        video.play();
                    })
                    .catch((err) => {
                        console.error("Camera error: ", err);
                        alert("Could not access the camera. Please check permissions.");
                    });
                } else {
                    alert("Camera API not supported in your browser.");
                }
            }
            
            // Stop camera when switching away from camera option
            function stopCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    video.srcObject = null;
                    stream = null;
                }
            }
            
            // Toggle between photo options
            function togglePhotoOption() {
                const option = document.getElementById("photoOption").value;
                
                // Hide all options first
                document.getElementById('cameraOption').classList.remove('active');
                document.getElementById('uploadOption').classList.remove('active');
                
                // Show selected option
                if (option === 'camera') {
                    document.getElementById('cameraOption').classList.add('active');
                    initCamera();
                    // Clear upload fields
                    uploadInput.value = '';
                    imagePreview.style.display = 'none';
                    document.getElementById('uploadError').style.display = 'none';
                } else if (option === 'upload') {
                    document.getElementById('uploadOption').classList.add('active');
                    stopCamera();
                    // Clear camera fields
                    capturedPhoto.style.display = 'none';
                    document.getElementById('cameraError').style.display = 'none';
                }
                
                // Hide option error when an option is selected
                document.getElementById('photoOptionError').style.display = 'none';
                checkFormCompletion();
            }
            
            // Capture photo from camera
            function snap() {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                photoDataUrl = canvas.toDataURL("image/png");
                capturedPhoto.src = photoDataUrl;
                capturedPhoto.style.display = 'block';
                document.getElementById('cameraError').style.display = 'none';
                checkFormCompletion();
            }
            
            // Handle file upload
            uploadInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file type
                    if (!file.type.match('image.*')) {
                        alert("Please select an image file (JPEG, PNG, etc.)");
                        uploadInput.value = '';
                        return;
                    }
                    
                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert("Image size should be less than 5MB");
                        uploadInput.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        imagePreview.src = event.target.result;
                        imagePreview.style.display = 'block';
                        photoDataUrl = event.target.result;
                        document.getElementById('uploadError').style.display = 'none';
                        checkFormCompletion();
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Check if all form fields are completed
            function checkFormCompletion() {
                const name = document.getElementById("name").value;
                const parentsName = document.getElementById("parentsName").value;
                const address = document.getElementById("address").value;
                const phone = document.getElementById("phone").value;
                const standard = document.getElementById("standard").value;
                const division = document.getElementById("division").value;
                const bloodGroup = document.getElementById("bloodGroup").value;
                const admissionNo = document.getElementById("admissionNo").value;
                const dob = document.getElementById("dob").value;
                const photoOption = document.getElementById("photoOption").value;
                
                // Check if photo is available
                let hasPhoto = false;
                if (photoOption === 'camera' && photoDataUrl) {
                    hasPhoto = true;
                } else if (photoOption === 'upload' && uploadInput.files[0]) {
                    hasPhoto = true;
                }
                
                // Show submit button only if all conditions are met
                if (name && parentsName && address && phone && standard && division && bloodGroup && admissionNo && dob && photoOption && hasPhoto) {
                    document.getElementById("submitButton").style.display = 'inline-block';
                } else {
                    document.getElementById("submitButton").style.display = 'none';
                }
            }

            // Add event listeners to all relevant fields
            document.getElementById("name").addEventListener('input', checkFormCompletion);
            document.getElementById("parentsName").addEventListener('input', checkFormCompletion);
            document.getElementById("address").addEventListener('input', checkFormCompletion);
            document.getElementById("phone").addEventListener('input', checkFormCompletion);
            document.getElementById("standard").addEventListener('change', checkFormCompletion);
            document.getElementById("division").addEventListener('change', checkFormCompletion);
            document.getElementById("bloodGroup").addEventListener('change', checkFormCompletion);
            document.getElementById("admissionNo").addEventListener('input', checkFormCompletion);
            document.getElementById("dob").addEventListener('change', checkFormCompletion);
            document.getElementById("photoOption").addEventListener('change', checkFormCompletion);

            // Submit form data
            async function submitForm() {
                const name = document.getElementById("name").value;
                const parentsName = document.getElementById("parentsName").value;
                const address = document.getElementById("address").value;
                const phone = document.getElementById("phone").value;
                const standard = document.getElementById("standard").value;
                const division = document.getElementById("division").value;
                const bloodGroup = document.getElementById("bloodGroup").value;
                const admissionNo = document.getElementById("admissionNo").value;
                const dob = document.getElementById("dob").value;
                const photoOption = document.getElementById("photoOption").value;
                const submitButton = document.getElementById("submitButton");
                const loader = document.getElementById("loader");
                
                // Validate form before submission
                if (!name || !parentsName || !address || !phone || !standard || !division || !bloodGroup || !admissionNo || !dob || !photoOption) {
                    alert("Please fill all required fields");
                    return;
                }
                
                if ((photoOption === 'camera' && !photoDataUrl) || 
                    (photoOption === 'upload' && !uploadInput.files[0])) {
                    alert("Please provide a photo");
                    return;
                }
                
                try {
                    // Show loader and disable button
                    loader.style.display = "block";
                    submitButton.disabled = true;
                    
                    // Get the image data based on selected option
                    let imageData = '';
                    if (photoOption === 'camera') {
                        imageData = photoDataUrl;
                    } else if (photoOption === 'upload') {
                        // Read uploaded file as base64
                        imageData = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (event) => resolve(event.target.result);
                            reader.readAsDataURL(uploadInput.files[0]);
                        });
                    }
                    
                    // Prepare the data object with all fields
                    const formData = {
                        name: name,
                        parentsName: parentsName,
                        address: address,
                        phone: phone,
                        standard: standard,
                        division:division,
                        bloodGroup: bloodGroup,
                        admissionNo: admissionNo,
                        dob: dob,
                        image: imageData
                    };
                    
                    console.log("Submitting data:", formData);
                    
                    // Make the API call with JSON content type
                    const response = await fetch("send.php", {
                        method: "POST",
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        document.getElementById('submitSuccessMessage').classList.remove('d-none');
                    } else {
                        throw new Error(result.message || 'Request failed');
                    }
                    
                    // Reset form
                    contactForm.reset();
                    photoDataUrl = '';
                    capturedPhoto.style.display = 'none';
                    imagePreview.style.display = 'none';
                    stopCamera();
                    document.getElementById('photoOption').value = '';
                    document.getElementById('cameraOption').classList.remove('active');
                    document.getElementById('uploadOption').classList.remove('active');
                    document.getElementById('submitButton').style.display = 'none';
                    
                } catch (error) {
                    console.error("Error:", error);
                    alert("Error sending data: " + error.message);
                    document.getElementById('submitErrorMessage').classList.remove('d-none');
                } finally {
                    // Hide loader and re-enable button
                    loader.style.display = "none";
                    submitButton.disabled = false;
                }
            }
            
            
            // Set up form submission
            document.getElementById("submitButton").addEventListener('click', submitForm);
            
            // Clean up camera stream when page unloads
            window.addEventListener('beforeunload', function() {
                stopCamera();
            });
        </script>
        
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
    </body>
</html>